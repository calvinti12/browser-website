<div id="vert-template" data-template='
  <iframe 
    id="{id}" 
    name="{id}" 
    style="max-height: 300px;" 
    sandbox="allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-top-navigation-by-user-activation" 
    width="100%" height="100%" 
    frameborder="0" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" 
    src="{src}"
  ></iframe>
'>

</div>

<script async defer type="text/javascript">
  Manager.ready(function () {
    var select = Manager.dom().select;
    var $adblockerDetector = select('#uj-antivert-detector');

    var $iframeVertTemplate = select('#vert-template').get(0).getAttribute('data-template');

    // Check if adblocker detector exists
    if (typeof Manager.properties.global.isAdblockerEnabled === 'undefined') {
      Manager.properties.global.isAdblockerEnabled = true;
      
      // Load the adblocker detector
      Manager.dom().loadScript({src: '/assets/js/taboola_ads.js'})
      .catch(function (e) {
        console.error('Failed to load adblock checker', e);
      })
      .finally(function () {
        Manager.properties.global.isAdblockerEnabled = !select('#uj-antivert-detector').elements.exists;

        console.log('Adblock enabled', Manager.properties.global.isAdblockerEnabled);

        // If adblocker is enabled, load the ad units
        if (Manager.properties.global.isAdblockerEnabled) {
          var $vertSlots = select('.uj-vert-unit');
          var slotId = new Date().getTime();
          // var adURL = window.location.protocol + '://' + window.location.host
          var adURL = Manager.properties.meta.environment === 'development'
            ? 'http://localhost:4001/vert'
            : 'https://promo-server.itwcreativeworks.com/vert'

          adURL = new URL(adURL);

          adURL.searchParams.set('url', window.location.href);

          // Load the ad units
          $vertSlots.each(function ($el) {
            var finalURL = new URL(adURL.toString());

            var parentElHeight = $el.parentElement.offsetHeight;
            var parentElWidth = $el.parentElement.offsetWidth;

            finalURL.searchParams.set('parentElHeight', parentElHeight);
            finalURL.searchParams.set('parentElWidth', parentElWidth);
            finalURL.searchParams.set('cb', slotId);

            finalURL = finalURL.toString();

            $el.innerHTML = $iframeVertTemplate
              .replace(/{id}/g, 'uj-vert-' + slotId++)
              .replace(/{src}/g, finalURL)
          })
        }
      })
    }
  })
</script>
